{% extends "base.html" %}

{% block title %}Sample Image Matches - News Scan AI{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-11">
      <div class="mb-3 d-flex justify-content-between align-items-center">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </a>
        <h5 class="mb-0">Matching results for image1, image2, and image3</h5>
      </div>

      <!-- Video Player -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class="mb-2"><strong>Video Preview</strong></div>
          <video id="resultVideo" controls style="width: 100%; height: 420px; background: #000;" preload="metadata">
            <source src="{{ url_for('serve_video') }}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      </div>

      {% for item in multi_results %}
      <div class="card shadow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0"><i class="fas fa-image"></i> {{ item.label | capitalize }} ({{ item.filename }})</h6>
          </div>
          <div>
            {% if item.matches_found > 0 %}
              <span class="badge bg-success">{{ item.matches_found }} matches</span>
            {% else %}
              <span class="badge bg-warning text-dark">No matches</span>
            {% endif %}
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="mb-2"><small class="text-muted">Reference image</small></div>
              <img src="/{{ item.image_url }}" alt="{{ item.label }}" class="img-fluid rounded shadow" style="max-height: 220px;">
            </div>
            <div class="col-md-8">
              <div class="mb-3">
                <h6 class="mb-2">Found at timestamps</h6>
                {% if item.time_ranges %}
                  {% for range in item.time_ranges %}
                  <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                    <span>{{ range.start_formatted }} - {{ range.end_formatted }}</span>
                    <button class="btn btn-sm btn-primary" onclick="playAt({{ range.start_time }})">
                      <i class="fas fa-play"></i> Play
                    </button>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted">No time ranges identified.</div>
                {% endif %}
              </div>

              {% if item.detailed_matches %}
              <div class="table-responsive">
                <table class="table table-sm table-hover align-middle">
                  <thead>
                    <tr>
                      <th>Timestamp</th>
                      <th>Score</th>
                      <th>Frame</th>
                      <th class="d-none d-md-table-cell">Details</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for match in item.detailed_matches %}
                    <tr>
                      <td>
                        <span class="badge bg-primary">{{ "%.2f"|format(match.timestamp) }}s</span>
                      </td>
                      <td style="min-width: 160px;">
                        <div class="progress" style="height: 18px;">
                          <div class="progress-bar" role="progressbar" style="width: {{ (match.similarity_score * 100)|round }}%">
                            {{ "%.0f"|format(match.similarity_score * 100) }}%
                          </div>
                        </div>
                      </td>
                      <td>
                        {% set frame_path = match.frame_path.replace('\\', '/') %}
                        <img src="{{ url_for('frame_file', filename=frame_path.split('frames/')[1]) }}" alt="Frame" class="img-thumbnail" style="max-width: 90px; max-height: 60px;">
                      </td>
                      <td class="d-none d-md-table-cell">
                        <small>
                          Hist: {{ "%.2f"|format(match.hist_similarity) }} | 
                          Tmpl: {{ "%.2f"|format(match.template_similarity) }} | 
                          Struct: {{ "%.2f"|format(match.struct_similarity) }}
                        </small>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}

      <div class="text-center">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
          <i class="fas fa-home"></i> Back to Home
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function playAt(seconds) {
  const video = document.getElementById('resultVideo');
  if (video) {
    video.currentTime = seconds;
    video.play();
    video.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}
</script>
{% endblock %}
